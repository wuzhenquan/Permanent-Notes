https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/70

注意，这是 https 的 ssl 握手，不是 TCP 握手



1. 客户端使用https的url访问web服务器,要求与服务器建立ssl连接
2. web服务器收到客户端请求后, 会将网站的证书(包含公钥)传送一份给客户端
3. 客户端收到网站证书后会检查证书的颁发机构以及过期时间, 如果没有问题就随机产生一个秘钥
4. 客户端利用公钥将会话秘钥加密, 并传送给服务端, 服务端利用自己的私钥解密出会话秘钥
5. 之后服务器与客户端使用秘钥加密传输



### SSL

了解对称加密和非对称加密，了解 ssl 是怎样结合对称和非对称的优势的

https://github.com/liuhanqu/fe-interview/issues/1

加密和解密都使用同一种算法的加密方法，称之为**对称加密**。加密和解密使用不同的算法，则为非对称加密。

对称加密需要一把钥匙就够了，因为加密和解密使用的是同一把钥匙。

非对称加密算法需要两把钥匙，公钥和私钥，它们是一对。用公钥加密的密文只能用相应的私钥解开，用私钥加密的密文只能用相应的公钥解开。其中，公钥是公开的，私钥是不对外公开的。

两者的主要区别在于密钥的长度不同，长度越长，相应的加/解密花费的时间就会更长，对称加密使用的密钥长度会短一些。

SSL 结合了这两种加密算法的有点。利用非对称加密算法来协商生成对称加密的密钥，然后之后就用对称加密来进行通信。**ssl 握手的时候是用非对称，传输的时候是用对称。** 对称加密的密钥在传输时经过了非对称加密，即使密钥被劫持了因为不知道非对称的私钥，所以也不会被破解。

简单来说就是：

客户端发起 HTTPS 请求→服务端返回证书→客户端对证书进行验证→验证通过后本地生成用于改造对称加密算法的随机数→通过证书中的公钥对随机数进行加密传输到服务端→服务端接收后通过私钥解密得到随机数→之后的数据交互通过对称加密算法进行加解密。

#### 为什么数据传输是用对称加密？

**首先：**非对称加密的加解密效率是非常低的，而 http 的应用场景中通常端与端之间存在大量的交互，非对称加密的效率是无法接受的。

**另外：**在 HTTPS 的场景中只有服务端保存了私钥，一对公私钥只能实现单向的加解密，所以HTTPS 中内容传输加密采取的是对称加密，而不是非对称加密。

### 为什么需要 CA 认证机构颁发证书？

https://zhuanlan.zhihu.com/p/96494976

**防止”中间人“攻击，同时可以为网站提供身份证明。 **

1. 本地请求被劫持（如DNS劫持等），所有请求均发送到中间人的服务器；
2. 中间人服务器返回中间人自己的证书；
3. 客户端创建随机数，通过中间人证书的公钥对随机数加密后传送给中间人，然后凭随机数构造对称加密对传输内容进行加密传输；
4. 中间人因为拥有客户端的随机数，可以通过对称加密算法进行内容解密；
5. 中间人以客户端的请求内容再向正规网站发起请求；
6. 因为中间人与服务器的通信过程是合法的，正规网站通过建立的安全通道返回加密后的数据；
7. 中间人凭借与正规网站建立的对称加密算法对内容进行解密；
8. 中间人通过与客户端建立的对称加密算法对正规内容返回的数据进行加密传输；
9. 客户端通过与中间人建立的对称加密算法对返回结果数据进行解密。

由于缺少对证书的验证，所以客户端虽然发起的是 HTTPS 请求，但客户端完全不知道自己的网络已被拦截，传输内容被中间人全部窃取。

### 证书的合法性依据是什么？

1. 只有认证的权威机构才能颁发证书。
2. 权威机构对申请者进行审核

### 浏览器如何验证证书的合法性？

https://zhuanlan.zhihu.com/p/96494976

**浏览器发起 HTTPS 请求时，服务器会返回网站的 SSL 证书，浏览器需要对证书做以下验证：** 

- 1）验证域名、有效期等**信息是否正确**：证书上都有包含这些信息，比较容易完成验证；
- 2）判断证书**来源是否合法**：每份签发证书都可以根据验证链查找到对应的根证书，操作系统、浏览器会在本地存储权威机构的根证书，利用本地根j证书可以对对应机构签发证书完成来源验证（如下图所示）：

![img](https://pic2.zhimg.com/v2-e603f41f298880ca91745bbf1d8327fd_b.jpg)

- 3）判断证书**是否被篡改**：需要与 CA 服务器进行校验；
- 4）判断证书**是否已吊销**：通过CRL（Certificate Revocation List 证书注销列表）和 OCSP（Online Certificate Status Protocol 在线证书状态协议）实现，其中 OCSP 可用于第3步中以减少与 CA 服务器的交互，提高验证效率。

以上任意一步都满足的情况下浏览器才认为证书是合法的。

##### 既然证书是公开的，如果要发起中间人攻击，我在官网上下载一份证书作为我的服务器证书，那客户端肯定会认同这个证书是合法的，如何避免这种证书冒用的情况？

其实这就是非加密对称中公私钥的用处，虽然中间人可以得到证书，但私钥是无法获取的，一份公钥是不可能推算出其对应的私钥，中间人即使拿到证书也无法伪装成合法服务端，因为无法对客户端传入的加密数据进行解密。

#### 本地随机数被窃取怎么办？

其实 HTTPS 并不包含对随机数的安全保证，HTTPS 保证的只是传输过程安全，而随机数存储于本地，本地的安全属于另一安全范畴，应对的措施有安装杀毒软件、反木马、浏览器升级修复漏洞等。

#### 用了 HTTPS 会被抓包吗？

HTTPS 的数据是加密的，常规下抓包工具代理请求后抓到的包内容是加密状态，无法直接查看。但是，正如前文所说，浏览器只会提示安全风险，如果用户授权仍然可以继续访问网站，完成请求。因此，只要客户端是我们自己的终端，我们授权的情况下，便可以组建中间人网络，而抓包工具便是作为中间人的代理。通常 HTTPS 抓包工具的使用方法是会生成一个证书，用户需要手动把证书安装到客户端中，然后终端发起的所有请求通过该证书完成与抓包工具的交互，然后抓包工具再转发请求到服务器，最后把服务器返回的结果在控制台输出后再返回给终端，从而完成整个请求的闭环。

### 完整的握手过程

![img](https://raw.githubusercontent.com/liuhanqu/blog/master/images/https/https-handshake.jpg) 

### 数字证书申请流程

1. 网站提交身份信息给CA机构
2. CA机构审核信息的真实性
3. 对信息进行Hash，计算信息摘要
4. CA机构的密钥加密信息摘要，得到数字签名

![image](https://user-images.githubusercontent.com/13450124/76215608-16551c80-624a-11ea-9c8a-0a4f919dda52.png) 

### 如何配置SSL

https://blog.csdn.net/dadadeganhuo/article/details/80265808 



### 其他

[看完还不懂HTTPS我直播吃翔](https://blog.csdn.net/winwill2012/article/details/71774469) 